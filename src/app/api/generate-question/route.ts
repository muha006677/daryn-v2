import { NextRequest, NextResponse } from 'next/server'
import { getOpenAIClient, getModelName } from '@/lib/openai'

export type Domain = 
  | 'math_logic'
  | 'math_ultra'
  | 'kaz_poem'
  | 'kaz_essay'
  | 'kaz_retell'
  | 'memory'
  | 'reaction'
  | 'reading'
  | 'mixed'

export type Difficulty = 'hard' | 'very_hard' | 'ultra'

export interface Question {
  id: string
  domain: string
  grade: number
  type: 'mcq' | 'short' | 'open'
  prompt: string
  options?: string[]
  answer: string
  explanation?: string
  meta?: any
}

// Барлық қиындық деңгейін ULTRA-ға қалыптастыру
function normalizeDifficulty(input?: string): Difficulty {
  return 'ultra'
}

// Domain шекара ережелері
const domainRules: Record<Domain, string> = {
  kaz_poem: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ - ҚАТАН ҚАДАҒАЛАУ:

МІНДЕТТІ ҚОЛДАНУ:
- ТЕК "өлең құрастыру", "тармақ", "ұйқас", "образ", "эмоция", "рифма", "өлшем" бойынша тапсырмалар
- Өлең құрастыру техникасы, тармақтар арасындағы байланыс, тақырып/эмоция сәйкестігі

ҚАТАН ТЫЮ:
- Тыю: Сандар, есептеу, формула, геометрия, оператор (+, -, ×, ÷, %)
- Тыю: "есепте", "қосу", "алу", "көбейту", "бөлу", "теңдеу", "формула" сөздері
- Тыю: Кез келген математикалық тапсырма

ЕГЕР ОСЫ ДОМЕНГЕ ҚАТЫСЫ ЖОҚ ТАПСЫРМА ПАЙДА БОЛСА, ОНЫ БІРДЕН АЛЫП ТАСТАП, ҚАЙТАДАН ТЕК ОСЫ ДОМЕНГЕ САЙ СҰРАҚ ҚҰРАСТЫР.`,

  kaz_essay: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ - ҚАТАН ҚАДАҒАЛАУ:

МІНДЕТТІ ҚОЛДАНУ:
- ТЕК "эссе құрылымы", "тезис", "дәлел", "қорытынды", "стиль", "сөйлем құрылымы", "мазмұн" бойынша тапсырмалар
- Эссе жазудың техникасы, логикалық құрылым, дәлелдеу, тақырыпты талдау

ҚАТАН ТЫЮ:
- Тыю: Кез келген математикалық есеп, сандар, есептеу, формула
- Тыю: "есепте", "қосу", "алу", "көбейту", "бөлу", "теңдеу", "формула", "геометрия" сөздері
- Тыю: Кез келген математикалық тапсырма

ЕГЕР ОСЫ ДОМЕНГЕ ҚАТЫСЫ ЖОҚ ТАПСЫРМА ПАЙДА БОЛСА, ОНЫ БІРДЕН АЛЫП ТАСТАП, ҚАЙТАДАН ТЕК ОСЫ ДОМЕНГЕ САЙ СҰРАҚ ҚҰРАСТЫР.`,

  kaz_retell: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ - ҚАТАН ҚАДАҒАЛАУ:

МІНДЕТТІ ҚОЛДАНУ:
- Міндетті: Қысқа мәтін + мазмұндама нұсқаулығы
- Мәтінді түсіну, негізгі ойды шығару, детальдарды есте сақтау, қысқаша мазмұндау

ҚАТАН ТЫЮ:
- Тыю: Кез келген есептеу тапсырмасы, математика
- Тыю: "есепте", "қосу", "алу", "көбейту", "бөлу", "теңдеу", "формула", "геометрия", "сан", "есеп" сөздері
- Тыю: Кез келген математикалық тапсырма

ЕГЕР ОСЫ ДОМЕНГЕ ҚАТЫСЫ ЖОҚ ТАПСЫРМА ПАЙДА БОЛСА, ОНЫ БІРДЕН АЛЫП ТАСТАП, ҚАЙТАДАН ТЕК ОСЫ ДОМЕНГЕ САЙ СҰРАҚ ҚҰРАСТЫР.`,

  reading: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ - ҚАТАН ҚАДАҒАЛАУ:

МІНДЕТТІ ҚОЛДАНУ:
- Міндетті: Мәтін + сұрақтар форматы
- Мәтінді түсіну, логикалық ойлау, қорытынды жасау

ҚАТАН ТЫЮ:
- Тыю: Кез келген есептеу, математика
- Тыю: "есепте", "қосу", "алу", "көбейту", "бөлу", "теңдеу", "формула", "геометрия", "сан", "есеп" сөздері
- Тыю: Кез келген математикалық тапсырма

ЕГЕР ОСЫ ДОМЕНГЕ ҚАТЫСЫ ЖОҚ ТАПСЫРМА ПАЙДА БОЛСА, ОНЫ БІРДЕН АЛЫП ТАСТАП, ҚАЙТАДАН ТЕК ОСЫ ДОМЕНГЕ САЙ СҰРАҚ ҚҰРАСТЫР.`,

  math_logic: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ - ҚАТАН ҚАДАҒАЛАУ:

МІНДЕТТІ ҚОЛДАНУ:
- ТЕК логика/математика бойынша тапсырмалар
- Заңдылық табу, комбинаторика, шартты логика, сан тізбектері, диаграмма/кесте

ҚАТАН ТЫЮ:
- Тыю: Өлең, эссе, мазмұндама, мәтін құрастыру
- Тыю: Тілдік тапсырмалар, шығармашылық жазба

ЕГЕР ОСЫ ДОМЕНГЕ ҚАТЫСЫ ЖОҚ ТАПСЫРМА ПАЙДА БОЛСА, ОНЫ БІРДЕН АЛЫП ТАСТАП, ҚАЙТАДАН ТЕК ОСЫ ДОМЕНГЕ САЙ СҰРАҚ ҚҰРАСТЫР.`,

  math_ultra: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ - ҚАТАН ҚАДАҒАЛАУ:

МІНДЕТТІ ҚОЛДАНУ:
- ТЕК логика/математика бойынша тапсырмалар
- Көпқадамды есептер, аралас амалдар, стратегиялық есептер

ҚАТАН ТЫЮ:
- Тыю: Өлең, эссе, мазмұндама, мәтін құрастыру
- Тыю: Тілдік тапсырмалар, шығармашылық жазба

ЕГЕР ОСЫ ДОМЕНГЕ ҚАТЫСЫ ЖОҚ ТАПСЫРМА ПАЙДА БОЛСА, ОНЫ БІРДЕН АЛЫП ТАСТАП, ҚАЙТАДАН ТЕК ОСЫ ДОМЕНГЕ САЙ СҰРАҚ ҚҰРАСТЫР.`,

  memory: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ:
- Есте сақтау тапсырмалары - сандар, сөздер, әріптер, түстер, жануарлар тізбектері`,

  reaction: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ:
- Реакция ойыны - ережелер мен әрекеттер`,

  mixed: `
ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІ:
- Аралас пән - математика, оқу түсіну, есте сақтау, реакция аралас`
}

// ULTRA деңгей ережелері - барлық домен үшін қатаң талаптар
const ultraRules = `
СУПЕР ЖОҒАРЫ (ОЛИМПИАДА) ДЕҒЕЙ ЕРЕЖЕЛЕРІ - МІНДЕТТІ ҚОЛДАНУ:

1. ДАРЫНДЫ ОҚУШЫЛАРҒА АРНАЛҒАН:
   - Барлық тапсырмалар тек дарынды оқушыларға арналған
   - Орташа оқушыларға жеңіл тапсырмалар БОЛМАСЫН

2. МІНДЕТТІ: 3-5 ҚАДАМДЫҚ ОЙЛАНУ ҚАЖЕТ:
   - Бірден көрінетін жауап беретін жеңіл тапсырмалар БОЛМАСЫН
   - Әр тапсырма кемінде 3-5 қадамдық ойлану процесін қажет етеді
   - Бірнеше аспектіні қарастыру, бірнеше қадамды орындау

3. ОЛИМПИАДАЛЫҚ СТИЛЬ:
   - Олимпиадалық тапсырмаларға ұқсас күрделілік
   - Стратегиялық ойлау қабілетін тестілеу
   - Көрінгенден күрделірек, тереңірек ойлауды талап ету

4. ЗАҢДЫЛЫҚ/ДӘЛЕЛ ЭЛЕМЕНТІ МІНДЕТТІ:
   - Үлгі/заңдылық табу - күрделі, бірнеше деңгейлі
   - Дәлелдеуге ұқсас қысқа негіздеу - неге дұрыс екенін түсіндіру
   - Стратегия таңдауы - неге дәл осы тәсілді таңдау керек

5. БІРДЕН КӨРІНБЕЙТІН ЖАУАП:
   - Бірден көрінетін жауап ЖОҚ
   - Бірнеше қадам арқылы шешу керек
   - Күрделі логикалық құрылымдар

6. АБСТРАКЦИЯ ЖӘНЕ ОЙЛАУ:
   - Жоғары деңгейдегі абстракция
   - Қарапайым сандар мен шамалар емес, қатынастар мен логикалық құрылымдар
   - Көп нұсқасы бар есептер (бірнеше тәсілмен шешуге болады)
`

const ultraMathAddon = `
МАТЕМАТИКА ULTRA-ADDON (math_logic және math_ultra үшін):

1. КӨПҚАДАМДЫ ТҮРЛЕНДІРУЛЕР:
   - Көпқадамды алгебралық/арифметикалық түрлендірулер
   - Бірнеше қадамды есептеулерді біріктіру

2. КҮРДЕЛІ КОМБИНАЦИЯЛАР:
   - Көп қабатты шарттар мен ережелер
   - Бірнеше принципті бірге қолдану (заңдылық + комбинаторика + логика)
   - Күрделірек сан тізбектері мен заңдылықтар

3. СТРАТЕГИЯЛЫҚ ШЕШУ ӘДІСТЕРІ:
   - Ең жақсы тәсілді табу - бірнеше тәсіл бар, бірақ ең тиімдісін таңдау
   - Геометриялық/алгебралық интуиция (егер сыныпқа сай болса)

4. ШЕШУ ЖОЛЫН ТҮСІНДІРУ:
   - Неге дұрыс екенін түсіндіру
   - Неге басқа нұсқа жарамайды
   - Әр қадамның логикалық негізі

5. АЗ САН, БІРАҚ КҮРДЕЛІ ҚҰРЫЛЫМ:
   - Қарапайым сандар, бірақ күрделі қатынастар
   - Күрделі логикалық құрылымдар
   - Бірнеше аспектіні қарастыру
`

// Математикалық белгілерді тексеру
function containsMathKeywords(text: string): boolean {
  const mathPatterns = [
    /[+\-×÷%=]/,
    /\d+\s*[+\-×÷]\s*\d+/,
    /есепте/,
    /қосу|алу|көбейту|бөлу/,
    /теңдеу/,
    /формула/,
    /геометрия/,
    /\d+\s*сан/,
    /математикалық\s*есеп/,
    /есеп\s*шеш/
  ]
  
  const lowerText = text.toLowerCase()
  return mathPatterns.some(pattern => pattern.test(lowerText))
}

// Domain-ға сай екенін тексеру
function validateDomainCompliance(questions: Question[], domain: Domain): boolean {
  if (domain === 'kaz_poem' || domain === 'kaz_essay' || domain === 'kaz_retell' || domain === 'reading') {
    // Тілдік домендер үшін математикалық белгілерді тексеру
    for (const q of questions) {
      const combinedText = `${q.prompt} ${q.answer} ${q.explanation || ''}`.toLowerCase()
      if (containsMathKeywords(combinedText)) {
        return false
      }
    }
  }
  
  if (domain === 'math_logic' || domain === 'math_ultra') {
    // Математика домендері үшін тілдік тапсырмаларды тексеру
    const languagePatterns = [/өлең/, /эссе/, /мазмұндама/, /тармақ/, /ұйқас/]
    for (const q of questions) {
      const combinedText = `${q.prompt} ${q.answer}`.toLowerCase()
      if (languagePatterns.some(pattern => pattern.test(combinedText))) {
        return false
      }
    }
  }
  
  return true
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { grade, domain, difficulty, count = 5, seed } = body

    if (!grade || !domain) {
      return NextResponse.json(
        { error: 'Сынып және бағыт міндетті.' },
        { status: 400 }
      )
    }

    // Барлық қиындық деңгейін ULTRA-ға қалыптастыру
    const normalizedDifficulty = normalizeDifficulty(difficulty)

    const gradeNum = parseInt(grade.toString(), 10)
    if (gradeNum < 1 || gradeNum > 6) {
      return NextResponse.json(
        { error: 'Сынып 1-6 аралығында болуы керек.' },
        { status: 400 }
      )
    }

    let openai
    try {
      openai = getOpenAIClient()
    } catch (error) {
      return NextResponse.json(
        { error: error instanceof Error ? error.message : 'OpenAI кліентінің құрылуында қате.' },
        { status: 500 }
      )
    }

    const model = getModelName()
    const timestamp = Date.now()
    let uniqueSeed = seed ? `${seed}-${timestamp}` : `seed-${timestamp}-${Math.random().toString(36).substr(2, 9)}`

    // Генерация - қайталау механизмімен
    let questions: Question[] = []
    let attempts = 0
    const maxAttempts = 2

    while (attempts < maxAttempts) {
      attempts++
      if (attempts > 1) {
        // Қайта генерациялау үшін жаңа seed
        uniqueSeed = `${seed || 'retry'}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
      }

      const prompt = buildPrompt(domain as Domain, gradeNum, normalizedDifficulty, count, uniqueSeed)

      const completion = await openai.chat.completions.create({
        model,
        messages: [
          {
            role: 'system',
            content: 'Сен қазақ тілінде дарынды оқушыларға арналған СУПЕР ЖОҒАРЫ (ОЛИМПИАДА) ДЕҒЕЙЛІ тапсырмалар жасайтын педагогсың. Барлық тапсырмалар 100% қазақ тілінде болуы керек. Жауаптарыңды ТЕК JSON форматында бер. Ешқандай markdown, түсініктеме немесе қосымша мәтін қоспа. КҮРДЕЛІЛІК ЕРЕЖЕЛЕРІН ҚАТАН ҚАДАҒАЛА. БІРДЕН КӨРІНЕТІН ЖАУАП БЕРЕТІН ЖЕҢІЛ ТАПСЫРМАЛАР ЖАСАМА. ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІН ҚАТАН САҚТА.'
          },
          { role: 'user', content: prompt }
        ],
        temperature: 0.9,
        max_tokens: 3500,
      })

      const content = completion.choices[0]?.message?.content
      if (!content) {
        if (attempts >= maxAttempts) {
          return NextResponse.json(
            { error: 'AI жауап бере алмады.' },
            { status: 500 }
          )
        }
        continue
      }

      try {
        let cleanContent = content.trim()
        if (cleanContent.startsWith('```json')) cleanContent = cleanContent.slice(7)
        else if (cleanContent.startsWith('```')) cleanContent = cleanContent.slice(3)
        if (cleanContent.endsWith('```')) cleanContent = cleanContent.slice(0, -3)
        cleanContent = cleanContent.trim()

        const parsed = JSON.parse(cleanContent)
        
        let parsedQuestions: Question[] = []
        
        if (Array.isArray(parsed.questions)) {
          parsedQuestions = parsed.questions.map((q: any, idx: number) => ({
            id: q.id || `${domain}-${gradeNum}-${timestamp}-${idx}`,
            domain,
            grade: gradeNum,
            type: q.type || 'short',
            prompt: q.prompt || q.q || '',
            options: q.options,
            answer: q.answer || q.a || '',
            explanation: q.explanation,
            meta: q.meta,
          }))
        } else if (Array.isArray(parsed.items)) {
          parsedQuestions = parsed.items.map((q: any, idx: number) => ({
            id: q.id || `${domain}-${gradeNum}-${timestamp}-${idx}`,
            domain,
            grade: gradeNum,
            type: q.type || 'short',
            prompt: q.prompt || q.q || '',
            options: q.options,
            answer: q.answer || q.a || '',
            explanation: q.explanation,
            meta: q.meta,
          }))
        }

        // Domain-ға сай екенін тексеру
        if (validateDomainCompliance(parsedQuestions, domain as Domain)) {
          questions = parsedQuestions
          break // Дұрыс болса, циклден шығу
        } else {
          // Domain сай келмесе, қайта генерациялау
          if (attempts >= maxAttempts) {
            // Соңғы әрекет болса, қате қайтару
            return NextResponse.json(
              { error: 'Domain шекара ережелерін сақтау мүмкін болмады. Қайта көріңіз.' },
              { status: 500 }
            )
          }
          // Қайталау
          continue
        }

      } catch (parseError) {
        console.error('JSON parse error:', parseError)
        if (attempts >= maxAttempts) {
          console.error('Raw content:', content)
          return NextResponse.json(
            { error: 'AI жауабын өңдеу мүмкін болмады.' },
            { status: 500 }
          )
        }
        continue
      }
    }

    // Егер сұрақтар жеткіліксіз болса, fallback
    while (questions.length < count) {
      questions.push({
        id: `${domain}-${gradeNum}-${timestamp}-fallback-${questions.length}`,
        domain,
        grade: gradeNum,
        type: 'short',
        prompt: '—',
        answer: '—',
      })
    }

    return NextResponse.json({ questions: questions.slice(0, count) })

  } catch (error) {
    console.error('Generate question error:', error)
    return NextResponse.json(
      { error: 'Қате орын алды. Қайта көріңіз.' },
      { status: 500 }
    )
  }
}

function buildPrompt(
  domain: Domain,
  grade: number,
  difficulty: Difficulty,
  count: number,
  seed: string
): string {
  const gradePolicy = getGradePolicy(grade)
  const isMath = domain === 'math_logic' || domain === 'math_ultra'
  const mathUltraAddonText = isMath ? ultraMathAddon : ''
  const domainBoundaryRules = domainRules[domain] || ''

  const basePrompt = `ДАРЫНДЫ ОҚУШЫЛАРҒА АРНАЛҒАН СУПЕР ЖОҒАРЫ (ОЛИМПИАДА) ДЕҒЕЙЛІ ТАПСЫРМАЛАР ЖАСА.

Сынып: ${grade}
Деңгей саясаты: ${gradePolicy}
Сессия ID: ${seed}

${ultraRules}

${domainBoundaryRules}

${mathUltraAddonText}

МАҢЫЗДЫ ТАЛАПТАР:
- Барлық тапсырмалар 100% қазақ тілінде
- Ешқандай рус, ағылшын, немесе басқа тілдегі мәтін болмасын
- Тапсырмалар шынында СУПЕР ЖОҒАРЫ (ОЛИМПИАДА) деңгейде, дарынды оқушыларға арналған
- Бірақ ${grade}-сыныпқа сай, бастауыш шегінде қалады
- Әр тапсырма өзіндік, бір-бірінен ерекшеленеді
- Алдыңғы 200 тапсырма шаблонын қайта пайдаланба
- Жауаптар нақты, дәл болсын
- БІРДЕН КӨРІНЕТІН ЖАУАП БЕРЕТІН ЖЕҢІЛ ТАПСЫРМАЛАР ЖАСАМА
- МІНДЕТТІ: Кемінде 3-5 қадамдық ойлану процесі
- ОЛИМПИАДА СТИЛІ: Заңдылық/дәлел элементі, стратегия таңдауы
- ДОМЕН ШЕКАРА ЕРЕЖЕЛЕРІН ҚАТАН САҚТА - осы доменге қатысы жоқ тапсырмаларды жасанба

`

  switch (domain) {
    case 'math_logic':
      return `${basePrompt}МАТЕМАТИКА & ЛОГИКА PRO:
- Заңдылық табу (pattern recognition) - күрделі, бірнеше деңгейлі комбинациялар
- Комбинаторикаға жеңіл кіріспе - санау принциптері, күрделі комбинациялар
- Шартты логика (if-then reasoning) - көп қабатты күрделі шарттар
- Диаграмма/кесте ойлау - деректерді терең талдау, қорытынды жасау
- Сан тізбектері, заңдылықтар - бірнеше деңгейлі заңдылықтар, күрделі комбинациялар
- Олимпиадалық логика - бірнеше қадам арқылы шешу, дәлел элементі
- Неге дұрыс екенін түсіндіру, неге басқа нұсқа жарамайды

${count} тапсырма жаса. JSON: { "questions": [{ "id": "...", "type": "short", "prompt": "...", "answer": "...", "explanation": "..." }] }`

    case 'math_ultra':
      return `${basePrompt}МАТЕМАТИКА ULTRA:
- Көпқадамды есептер - міндетті 3-5 қадам
- Аралас амалдар (+, -, ×, ÷) - күрделі комбинациялар, стратегиялық ойлау
- Стратегиялық есептер - ең жақсы тәсілді табу, бірнеше тәсіл бар
- Мәтінмен есептер - күрделі шарттарды талдау, бірнеше аспектіні қарастыру
- Есептеу жүйесі - логикалық қадамдарды біріктіру
- Олимпиадалық математика - бірнеше тәсілмен шешу, геометриялық/алгебралық ойлау
- Шешу жолын толық түсіндіру - әр қадамның логикалық негізі

${count} тапсырма жаса. JSON: { "questions": [{ "id": "...", "type": "short", "prompt": "...", "answer": "...", "explanation": "..." }] }`

    case 'kaz_poem':
      return `${basePrompt}ӨЛЕҢ ҚҰРАСТЫРУ:
- Алдыңғы 2 тармақ берілген
- Оқушы соған сай артқы 2 тармақты ойдан құрастырып 1 шумақ аяқтайды
- Тақырып/эмоция сәйкестігін сақта - күрделі тақырыптар мен эмоциялар
- Қазақ тілінің өлең өлшемі мен рифмасын ескер - дұрыс сақтау
- Шығармашылық қабілетті көрсету - күрделі тақырыптар, терең ойлау
- МІНДЕТТІ: Бірден көрінетін өлең емес, терең ойлау қажет
- ТІК ӨЛЕҢ ҚҰРАСТЫРУ - математика, есептеу, формула ЖОҚ

${count} тапсырма жаса. Әр тапсырма: алдыңғы 2 тармақ + нұсқау. JSON: { "questions": [{ "id": "...", "type": "open", "prompt": "Алдыңғы тармақтар:\\n[1-тармақ]\\n[2-тармақ]\\n\\nАртқы 2 тармақты құрастырып 1 шумақ аяқтаңыз.", "answer": "Үлгі жауап", "explanation": "..." }] }`

    case 'kaz_essay':
      const minSent = grade <= 2 ? 3 : grade <= 4 ? 5 : 8
      const maxSent = grade <= 2 ? 4 : grade <= 4 ? 7 : 10
      return `${basePrompt}ЭССЕ:
- Берілген тақырып бойынша қысқа эссе жазады
- Ұзындық: ${minSent}-${maxSent} сөйлем
- Мәтін құрылымы, дұрыс сөйлемдер
- Тақырыпқа сай мазмұн
- Күрделі тақырыптар - ойлау қабілетін талап етеді
- Логикалық құрылым - дәлелдер мен мысалдар, стратегиялық ойлау
- Тілдік өнертапқыштық - күрделі тақырыптар, терең ойлау
- МІНДЕТТІ: Бірден көрінетін жауап емес, бірнеше аспектіні қарастыру
- ТІК ЭССЕ ЖАЗУ - математикалық есеп, сандар, формула ЖОҚ

${count} тапсырма жаса. JSON: { "questions": [{ "id": "...", "type": "open", "prompt": "Тақырып: [тақырып]", "answer": "Үлгі эссе (${minSent}-${maxSent} сөйлем)", "explanation": "..." }] }`

    case 'kaz_retell':
      const timeLimit = grade <= 2 ? 60 : grade <= 4 ? 90 : 120
      return `${basePrompt}МӘТІНДІ ОҚЫП МАЗМҰНДАУ:
- Берілген мәтінді оқып ${timeLimit} секунд ішінде мазмұндап береді
- Негізгі ойды, маңызды детальдарды айта білу
- Дұрыс тіл, қысқаша мазмұндау
- Күрделі мәтіндер - бірнеше ой мен детальдар
- Негізгі мен екінші деңгейлі ақпаратты ажырату - стратегиялық ойлау
- Логикалық тізбекті сақтау - қатынастар мен құрылымдар
- МІНДЕТТІ: Бірден көрінетін мазмұн емес, терең талдау қажет
- МІНДЕТТІ: Қысқа мәтін + мазмұндама - математикалық есеп ЖОҚ

${count} мәтін жаса. JSON: { "questions": [{ "id": "...", "type": "open", "prompt": "[мәтін]", "answer": "Мазмұндама нұсқасы", "explanation": "${timeLimit} секунд уақыт", "meta": { "timeLimit": ${timeLimit} } }] }`

    case 'memory':
      const memCount = grade <= 2 ? 5 : grade <= 4 ? 7 : 9
      return `${basePrompt}ЕСТЕ САҚТАУ PRO:
- Қысқа уақыттық есте сақтау + назар тұрақтылығы + жылдам қайта жаңғырту
- Әр тізбекте ${memCount} элемент
- Сандар, сөздер, әріптер, түстер, жануарлар т.б.
- Күрделі тізбектер - бірнеше категория аралас
- Жылдам айнымалы шамалар - стратегиялық есте сақтау
- Назар тұрақтылығын тестілеу - күрделі комбинациялар
- МІНДЕТТІ: Қарапайым тізбек емес, күрделі логикалық құрылым

${count} тапсырма жаса. JSON: { "questions": [{ "id": "...", "type": "short", "prompt": "[элементтер тізбегі]", "answer": "Элемент саны: ${memCount}", "explanation": "...", "meta": { "items": [...], "count": ${memCount} } }] }`

    case 'reaction':
      return `${basePrompt}РЕАКЦИЯ "БАҒДАРШАМ":
- Ереже ауысатын реакция ойыны
- Түс көрсетілгенде дұрыс әрекет таңдау
- Жылдам реакция қабілеті
- Күрделі ережелер - бірнеше шарт, көп қабатты логика
- Ереже ауысу жиілігі жоғары - стратегиялық ойлау
- Логикалық дәйектеме қажет - неге дұрыс екенін түсіндіру
- МІНДЕТТІ: Бірден көрінетін ереже емес, күрделі комбинациялар

${count} ереже жаса. JSON: { "questions": [{ "id": "...", "type": "short", "prompt": "[түс]", "answer": "[әрекет]", "explanation": "..." }] }`

    case 'reading':
      return `${basePrompt}ОҚУ ТҮСІНУ:
- МІНДЕТТІ: Мәтін + сұрақтар форматы
- 2-4 сөйлем қысқа мәтін
- Мәтінді оқып, 2 сұраққа жауап беру
- Түсіну, логикалық ойлау
- Күрделі мәтіндер - бірнеше ой мен детальдар
- Логикалық қорытынды жасау - стратегиялық ойлау
- Ауыспалы мағыналар мен контекст - терең талдау
- МІНДЕТТІ: Бірден көрінетін жауап емес, терең ойлау қажет
- ТІК МӘТІН + СҰРАҚТАР - математикалық есеп ЖОҚ

${count} мәтін жаса. Әр мәтінге 2 сұрақ. JSON: { "questions": [{ "id": "...", "type": "open", "prompt": "Мәтін: [мәтін]\\n\\nСұрақтар:\\n1. [сұрақ 1]\\n2. [сұрақ 2]", "answer": "1. [жауап 1]\\n2. [жауап 2]", "explanation": "..." }] }`

    case 'mixed':
      return `${basePrompt}АРАЛАС ПӘН:
- Математика, оқу түсіну, есте сақтау, реакция
- Әртүрлі тапсырма түрлері
- Ойын форматына сай, қысқа, анық
- Күрделі аралас тапсырмалар - бірнеше пән элементтері
- Стратегиялық ойлау - күрделі комбинациялар
- Көпқадамды шешу процесі - міндетті 3-5 қадам
- МІНДЕТТІ: Бірден көрінетін жауап емес, терең ойлау қажет

${count} аралас тапсырма жаса. JSON: { "questions": [{ "id": "...", "type": "short", "prompt": "...", "answer": "...", "explanation": "..." }] }`

    default:
      return basePrompt
  }
}

function getGradePolicy(grade: number): string {
  if (grade <= 2) {
    return '1-2 сынып: Математика max 50, қысқа сөйлемдер, memory 4-5 элемент'
  } else if (grade <= 4) {
    return '3-4 сынып: Математика max 1000, көбейту/бөлу, memory 6-7 элемент'
  } else {
    return '5-6 сынып: Күрделі математика, ұзын сөйлемдер, memory 8-9 элемент'
  }
}
